
<!DOCTYPE html>
<html>
<head>
    <script src="https://unpkg.com/konva@2.4.2/konva.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>

    <meta charset="utf-8">
    <title>Konva Elastic Stars Demo</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #F0F0F0;
        }
    </style>
</head>
<body>
<h3 id="say_color">Say a color.</h3>
<span id="status_" class="inactive">SpeechRecognition is </span>

<div id="container"></div>


<script>
    if(!window.webkitSpeechRecognition){
        log('Sorry this will work only in Chrome for now...');
    }
    const magic_word = 'system';
    // initialize our SpeechRecognition object
    let recognition = new webkitSpeechRecognition();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    recognition.continuous = true;

    console.log('here');

    check_flag = false;


    // detect the magic word
    recognition.onresult = e => {
        var transcripts  = [].concat.apply([], [...e.results].map(res => [...res].map(alt => alt.transcript)));
        if(transcripts.some(t=>t.indexOf(magic_word)>-1)){
            // log('Say a color');
            check_flag = true;
            console.log('something');

            colour = transcripts.toString();
            colour = colour.toLowerCase();
            // strip the spaces out of it
            colour = colour.replace(/\s/gi,'');
            $('h3').text(colour);
            check_flag = true;

            console.log("colour",colour);




        }
        else{
            // log('understood ' + JSON.stringify(transcripts));


            // colour = JSON.stringify(transcripts);
            colour = transcripts.toString();
            colour = colour.toLowerCase();
            // strip the spaces out of it
            colour = colour.replace(/\s/gi,'');
            $('h3').text(colour);
            check_flag = true;

            console.log("colour",colour);

            var width = window.innerWidth;
            var height = window.innerHeight;

            var tween = null;

            function addStar(layer, stage) {
                var scale = Math.random();

                var color =  '#89b717';

                if(check_flag === true){
                    color = colour;
                }
                var star = new Konva.Star({
                    x: Math.random() * stage.width(),
                    y: Math.random() * stage.height(),
                    numPoints: 5,
                    innerRadius: 30,
                    outerRadius: 50,
                    fill: color,
                    // fill: '#89b717',
                    opacity: 0.8,
                    draggable: true,
                    scale: {
                        x : scale,
                        y : scale
                    },
                    rotation: Math.random() * 180,
                    shadowColor: 'black',
                    shadowBlur: 10,
                    shadowOffset: {
                        x : 5,
                        y : 5
                    },
                    shadowOpacity: 0.6,
                    startScale: scale
                });



                layer.add(star);
            }
            var stage = new Konva.Stage({
                container: 'container',
                width: width,
                height: height
            });

            var layer = new Konva.Layer();
            var dragLayer = new Konva.Layer();

            for(var n = 0; n < 10; n++) {
                addStar(layer, stage);
            }

            stage.add(layer);
            stage.add(dragLayer);

            // bind stage handlers
            stage.on('mousedown', function(evt) {
                var shape = evt.target;

                shape.moveTo(dragLayer);
                stage.draw();
                // restart drag and drop in the new layer
                shape.startDrag();
            });

            stage.on('mouseup', function(evt) {
                var shape = evt.target;
                shape.moveTo(layer);
                stage.draw();
            });

            stage.on('dragstart', function(evt) {
                var shape = evt.target;
                if (tween) {
                    tween.pause();
                }
                shape.setAttrs({
                    shadowOffset: {
                        x: 15,
                        y: 15
                    },
                    scale: {
                        x: shape.getAttr('startScale') * 1.2,
                        y: shape.getAttr('startScale') * 1.2
                    }
                });
            });

            stage.on('dragend', function(evt) {
                var shape = evt.target;

                tween = new Konva.Tween({
                    node: shape,
                    duration: 0.5,
                    easing: Konva.Easings.ElasticEaseOut,
                    scaleX: shape.getAttr('startScale'),
                    scaleY: shape.getAttr('startScale'),
                    shadowOffsetX: 5,
                    shadowOffsetY: 5
                });

                tween.play();
            });





        }
    };
    // called when we detect silence
    function stopSpeech(){
        setTimeout(function(){recognition.stop();
        },5000);
        setTimeout(function(){status_.className = 'inactive';
        },5000);


        // recognition.stop();
        // status_.className = 'inactive';
        // document.getElementById('listen').style.display = "none";

    }
    // called when we detect sound
    function startSpeech(){
        try{ // calling it twice will throw...
            if(check_flag === true){
                speech_flag = true;
                touch_flag = false;
                status_.className = 'active';

            }
            recognition.start();

        }
        catch(e){}
        // status_.className = 'active';
    }
    // request a LocalMediaStream
    navigator.mediaDevices.getUserMedia({audio:true})
    // add our listeners
        .then(stream => detectSilence(stream, stopSpeech, startSpeech))
        .catch(e => log(e.message));


    function detectSilence(
        stream,
        onSoundEnd = _=>{},
        onSoundStart = _=>{},
        silence_delay = 500,
        // silence_delay = 500,
        // min_decibels = -80
        min_decibels = -80

    ) {
        const ctx = new AudioContext();
        const analyser = ctx.createAnalyser();
        const streamNode = ctx.createMediaStreamSource(stream);
        streamNode.connect(analyser);
        analyser.minDecibels = min_decibels;

        const data = new Uint8Array(analyser.frequencyBinCount); // will hold our data
        let silence_start = performance.now();
        let triggered = false; // trigger only once per silence event

        function loop(time) {
            requestAnimationFrame(loop); // we'll loop every 60th of a second to check
            analyser.getByteFrequencyData(data); // get current data
            if (data.some(v => v)) { // if there is data above the given db limit
                if(triggered){
                    triggered = false;
                    onSoundStart();
                }
                silence_start = time; // set it to now
            }
            if (!triggered && time - silence_start > silence_delay) {
                onSoundEnd();
                triggered = true;
            }
        }
        loop();
    }
    function log(txt){
        log_.textContent += txt + '\n';
    }



    // var width = window.innerWidth;
    // var height = window.innerHeight;
    //
    // var tween = null;
    //
    // function addStar(layer, stage) {
    //     var scale = Math.random();
    //
    //     var color =  '#89b717';
    //
    //     if(check_flag === true){
    //         color = colour;
    //     }
    //     var star = new Konva.Star({
    //         x: Math.random() * stage.width(),
    //         y: Math.random() * stage.height(),
    //         numPoints: 5,
    //         innerRadius: 30,
    //         outerRadius: 50,
    //         fill: color,
    //         // fill: '#89b717',
    //         opacity: 0.8,
    //         draggable: true,
    //         scale: {
    //             x : scale,
    //             y : scale
    //         },
    //         rotation: Math.random() * 180,
    //         shadowColor: 'black',
    //         shadowBlur: 10,
    //         shadowOffset: {
    //             x : 5,
    //             y : 5
    //         },
    //         shadowOpacity: 0.6,
    //         startScale: scale
    //     });
    //
    //
    //
    //     layer.add(star);
    // }
    // var stage = new Konva.Stage({
    //     container: 'container',
    //     width: width,
    //     height: height
    // });
    //
    // var layer = new Konva.Layer();
    // var dragLayer = new Konva.Layer();
    //
    // for(var n = 0; n < 10; n++) {
    //     addStar(layer, stage);
    // }
    //
    // stage.add(layer);
    // stage.add(dragLayer);
    //
    // // bind stage handlers
    // stage.on('mousedown', function(evt) {
    //     var shape = evt.target;
    //
    //     shape.moveTo(dragLayer);
    //     stage.draw();
    //     // restart drag and drop in the new layer
    //     shape.startDrag();
    // });
    //
    // stage.on('mouseup', function(evt) {
    //     var shape = evt.target;
    //     shape.moveTo(layer);
    //     stage.draw();
    // });
    //
    // stage.on('dragstart', function(evt) {
    //     var shape = evt.target;
    //     if (tween) {
    //         tween.pause();
    //     }
    //     shape.setAttrs({
    //         shadowOffset: {
    //             x: 15,
    //             y: 15
    //         },
    //         scale: {
    //             x: shape.getAttr('startScale') * 1.2,
    //             y: shape.getAttr('startScale') * 1.2
    //         }
    //     });
    // });
    //
    // stage.on('dragend', function(evt) {
    //     var shape = evt.target;
    //
    //     tween = new Konva.Tween({
    //         node: shape,
    //         duration: 0.5,
    //         easing: Konva.Easings.ElasticEaseOut,
    //         scaleX: shape.getAttr('startScale'),
    //         scaleY: shape.getAttr('startScale'),
    //         shadowOffsetX: 5,
    //         shadowOffsetY: 5
    //     });
    //
    //     tween.play();
    // });
</script>

</body>
</html>